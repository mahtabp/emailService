# Email Service API

![emailService](logo.jpg)

This API sends emails to recipients via 2 email providers (mailGun & sendGrid):

<a href="https://documentation.mailgun.com/en/latest/">mailGun</a>

<a href="https://sendgrid.com/docs/"> sendGrid </a>

## Design
* controllers: the functions to be called based on the http requests
* Services: has the modules that implement business logic. eg. the logic to decide wher the traffic should go.
It also has the modules to interact with 3rd party email providers
* models: interfaces and classes that are shared across the application.
* test: unit and integration tests

## API contract Documents
API docs are generated by swagger.

<a href="http://localhost:3002/docs/">Local host link to Docs</a>

<a href="https://siteminderchallenge.azurewebsites.net/docs/">Integration link to Doc</a>

### Setup & Run locally
the API will be hosted on port 3000 if the environment variable is not set:
http://localhost:3000

```
npm install 
npm run build
```

### Run Tests
```
npm run test
```
Note: To run the integration tests successfully we should provide correct API keys

## Deployment
### EC2
* Deploy to EC2:
IP: http://18.191.127.172:3002/docs/

```
ssh -i ~/.ssh/mahtab-amazon-key.pem ec2-user@ec2-18-191-127-172.us-east-2.compute.amazonaws.com
git clone https://github.com/mahtabp/emailService.git
cd workspace/emailService
npm install
npm run build
```

### Azure
* Option 1:
This is the easiest and fastest option. download the <a href="https://code.visualstudio.com/tutorials/app-service-extension/getting-started"> Azure app-service-extension plugin for VS code </a>
login to azure portal and deploy to <u>siteminderchallenge web app</u> web app.

* option 2:
1. If you don't have Azure CLI you can download if from <a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest"> Azure CLI</a>

2. login to azure and enter your credentials
```
az login
```

3. Create a webapp, zip your files & deploy this new ZIP file to App Service
```
zip -r emailService.zip .
az webapp deployment source config-local-git --name YOR_APP_NAME --resource-group RESOURCE_GROUP_NAME --query url  --output tsv
git remote add azure URI from previoud step
git push azure master
```

## TODO:
* Some queue mechanism & retry logic in case both providers are down. 
option 1. Save the failed payload in a dynamo db and have a job to read from the table and send the emails
option 2. publish the failed payload to the event bus and have a background worker to read and send again
* Deploying to Azure was a new experience. Try other web servers eg. Amazon web servers 
* CI for automated deployment 
* integration with monitoring tools
* encrypting API keys
* some basic request body validation can be done by npm packages such as Joi. we don't need to build the wheel again.
